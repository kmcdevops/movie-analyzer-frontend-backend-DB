pipeline {
    agent any

    environment {
        REPO_URL = 'https://github.com/kmcdevops/movie-analyzer-frontend-backend-DB.git'
        APP_DIR = "${env.WORKSPACE}/movie-analyzer-project"
    }

    stages {
        stage('Clone Repository') {
            steps {
                deleteDir()
                dir("${APP_DIR}") {
                    git url: "${REPO_URL}", branch: 'main'
                }
                sh '''
                    echo "âœ… Repo cloned into: ${APP_DIR}"
                    echo "ğŸ—‚ï¸ Directory structure:"
                    ls -lR "${APP_DIR}"
                '''
            }
        }

        stage('Check Node and NPM') {
            steps {
                sh '''
                    echo "ğŸ” Checking Node and NPM installations..."
                    which node || echo "âŒ node not found"
                    node -v || echo "âŒ node not installed"

                    which npm || echo "âŒ npm not found"
                    npm -v || echo "âŒ npm not installed"
                '''
            }
        }

        stage('Debug Repo Structure') {
            steps {
                sh '''
                    echo "ğŸ” Printing all files under APP_DIR..."
                    find "${APP_DIR}" -type f
                '''
            }
        }

        stage('Build Frontend') {
            steps {
                dir("${APP_DIR}/frontend") {
                    sh '''
                        echo "ğŸ“¦ Running npm install..."
                        if [ ! -f package.json ]; then
                          echo "âŒ package.json not found in frontend/"
                          exit 1
                        fi
                        npm install

                        echo "ğŸ—ï¸ Running npm build..."
                        npm run build
                    '''
                }
            }
        }

        stage('Build Backend') {
            steps {
                dir("${APP_DIR}/backend") {
                    sh '''
                        echo "ğŸ“¦ Installing backend dependencies..."
                        if [ ! -f package.json ]; then
                          echo "âŒ package.json not found in backend/"
                          exit 1
                        fi
                        npm install
                    '''
                }
            }
        }

        stage('Build Model') {
            steps {
                dir("${APP_DIR}/model") {
                    sh '''
                        echo "ğŸ Installing Python model dependencies..."
                        if [ ! -f requirements.txt ]; then
                          echo "âŒ requirements.txt not found in model/"
                          exit 1
                        fi
                        pip3 install -r requirements.txt
                    '''
                }
            }
        }

        stage('Deploy Frontend') {
            steps {
                sh '''
                    echo "ğŸš€ Deploying frontend to /var/www/html..."
                    sudo rm -rf /var/www/html/*
                    sudo cp -r "${APP_DIR}/frontend/build/"* /var/www/html/
                '''
            }
        }

        stage('Run Backend') {
            steps {
                sh '''
                    echo "ğŸ”„ Restarting backend server..."
                    pkill -f "node backend/app.js" || true
                    nohup node "${APP_DIR}/backend/app.js" > backend.log 2>&1 &
                '''
            }
        }

        stage('Run Model') {
            steps {
                sh '''
                    echo "ğŸ”„ Restarting Python model server..."
                    pkill -f "python3 model/app.py" || true
                    nohup python3 "${APP_DIR}/model/app.py" > model.log 2>&1 &
                '''
            }
        }
    }

    post {
        success {
            echo 'ğŸ‰ Movie Analyzer deployed successfully!'
        }
        failure {
            echo 'âŒ Deployment failed. Please check the console logs.'
        }
    }
}
